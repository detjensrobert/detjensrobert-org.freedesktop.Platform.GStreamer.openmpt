id: org.freedesktop.Platform.GStreamer.openmpt
default-branch: '22.08'
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
build-extension: true
separate-locales: false
appstream-compose: false

build-options:
  # build to extension dir (only extension directory is persisted between modules, not /app or /usr)
  prefix: /usr/lib/extensions/gstreamer-1.0/openmpt
  prepend-pkg-config-path: /usr/lib/extensions/gstreamer-1.0/openmpt/lib/pkgconfig
  env:
    FLATPAK_LIBDIR: /usr/lib/extensions/gstreamer-1.0/openmpt/

cleanup:
  - /include
  - /bin
  - /lib/pkgconfig
  - /lib/libgst*
  - /lib/*.a
  - /lib/*.la
  - /libexec
  - /share

modules:
  # - name: libportaudiocpp
  #   buildsystem: autotools
  #   config-opts:
  #     - --enable-cxx
  #   no-parallel-make: true # https://github.com/PortAudio/portaudio/issues/540
  #   sources:
  #     - type: archive
  #       url: https://github.com/portaudio/portaudio/archive/v19.7.0/portaudio-v19.7.0.tar.gz
  #       sha512: 7e347a174109b661a685bcd617cc8fe00929c6fbf28f142fd7709a8ddbb9b5ed6e805be6647a44b4b9441b79e3474561de6f8e351b4ffc024952ed3e0e27ac1c

  - name: libopenmpt
    buildsystem: autotools
    config-opts:
      - --without-portaudio
      - --disable-openmpt123
      - --disable-examples
      - --disable-tests
    sources:
      - type: archive
        url: https://lib.openmpt.org/files/libopenmpt/src/libopenmpt-0.7.2+release.autotools.tar.gz
        sha512: 5a92641679c72694d29b2bfe46f50ad31c964426f43213b67561f67a21c5683a13a61b0810fced3c46c071f40857a2c564a68947334792e94830cbe66dc5716d

  - name: gstreamer-plugins-bad
    buildsystem: meson
    builddir: true
    config-opts:
      # build only openmpt plugin
      - -Dauto_features=disabled
      - -Dgood=disabled
      - -Dugly=disabled
      - -Dbad=enabled
      - -Dgst-plugins-bad:openmpt=enabled
      - -Dgst-full-plugins=openmpt
      - --buildtype=release
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/gstreamer/gstreamer.git
        tag: 1.20.6 # matches o.fd.P//22.08
        disable-submodules: true
    # only install the plugin, none of the other gstreamer files
    no-make-install: true
    post-install:
      - install -D subprojects/gst-plugins-bad/ext/openmpt/libgstopenmpt.so ${FLATPAK_LIBDIR}
